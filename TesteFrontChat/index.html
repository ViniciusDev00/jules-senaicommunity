<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Página de Testes WebSocket</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: auto; max-width: 900px; padding: 2rem; background-color: #f8f9fa; color: #333; }
        .container { background-color: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        h2, h3, h4 { color: #0056b3; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: .5rem; font-weight: bold; }
        input[type="text"], input[type="password"], input[type="number"], textarea, input[type="file"] { width: calc(100% - 22px); padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-right: 10px; vertical-align: middle;}
        button:hover { background-color: #0056b3; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #c82333; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #chat-window, #public-feed-window { height: 500px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-top: 1rem; background-color: #f9f9f9; border-radius: 4px; }
        .message, .post-container, .comment-container { position: relative; }
        .message-actions, .post-actions, .comment-actions { position: absolute; top: 5px; right: 5px; display: none; background-color: rgba(255,255,255,0.8); padding: 3px; border-radius: 5px;}
        .message:hover .message-actions, .post-container:hover .post-actions, .comment-container:hover .comment-actions { display: block; }
        .action-btn { font-size: 10px; padding: 2px 5px; margin: 0 2px; cursor: pointer; border-radius: 3px; }
        .message { margin-bottom: 8px; padding: 8px 12px; border-radius: 4px; max-width: 80%; word-wrap: break-word; }
        .message p { margin: 4px 0; }
        .message.sent { background-color: #d1e7dd; text-align: left; margin-left: auto; }
        .message.received { background-color: #e2e3e5; text-align: left; margin-right: auto; }
        #status { font-weight: bold; padding: 5px 10px; border-radius: 5px; display: inline-block; }
        #status.connected { color: #155724; background-color: #d4edda; }
        #status.disconnected { color: #721c24; background-color: #f8d7da; }
        #jwt-token { width: 100%; min-height: 60px; box-sizing: border-box; }
        .post-container { border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; background-color: #fff; }
        .post-header { font-weight: bold; margin-bottom: 8px; color: #333; }
        .post-content { margin-bottom: 10px; white-space: pre-wrap; }
        .post-media img, .post-media video, .post-media audio { max-width: 100%; border-radius: 4px; margin-top: 10px; display: block;}
        .comments-section { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .comment-container { background-color: #f8f9fa; padding: 8px; border-radius: 5px; margin-bottom: 8px; border-left: 2px solid #ddd; padding-left: 10px; }
        .comment-header { font-size: 0.9em; color: #6c757d; }
        .comment-content { font-size: 0.95em; }
        .comment-form { display: flex; margin-top: 10px; }
        .comment-form input { flex-grow: 1; margin-right: 10px; }
        .comment-form button { font-size: 14px; padding: 5px 10px; }
        .comment-replies { margin-left: 25px; border-left: 2px solid #e9ecef; padding-left: 15px; }
        .reply-form { margin-left: 25px; margin-top: 5px; display: none; }
        .destacado { background-color: #fffbe6 !important; border-left-color: #ffc107 !important; }
        .action-btn.highlight { background-color: #ffc107; color: black; border-color: #ffc107; }
        .reply-info { font-size: 0.8em; color: #6c757d; margin-bottom: 4px; }
        .reply-info strong { color: #0056b3; }
        .highlight-badge { font-size: 0.8em; color: #856404; background-color: #fff3cd; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
        
        /* <<< NOVOS ESTILOS PARA CURTIDAS >>> */
        .actions-bar {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px; /* Aumenta o espaçamento entre os botões */
        }
        .like-btn {
            background: none;
            border: 1px solid #ccc;
            color: #555;
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .like-btn.liked {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            font-weight: bold;
        }
        .like-count {
            font-size: 14px;
            color: #666;
            font-weight: bold;
        }
        .comment-actions-footer {
             display: flex;
             align-items: center;
             gap: 15px;
             margin-top: 10px;
        }

        /* Estilos do Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        #edit-post-media-list label { display: inline-block; margin-right: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Etapa 1: Autenticação</h2>
    <div class="form-group">
        <label for="backend-url">URL do Backend:</label>
        <input type="text" id="backend-url" value="http://localhost:8080">
    </div>
    <div class="form-group">
        <label for="email">Email:</label>
        <input type="text" id="email" placeholder="seu.email@exemplo.com">
    </div>
    <div class="form-group">
        <label for="password">Senha:</label>
        <input type="password" id="password" placeholder="Sua senha">
    </div>
    <button onclick="login()">1. Login</button>
    <div class="form-group" style="margin-top: 1rem;">
        <label for="jwt-token">Token JWT:</label>
        <textarea id="jwt-token" readonly></textarea>
    </div>
</div>

<div class="container">
    <h2>Etapa 2: Conexão WebSocket</h2>
    <div class="form-group">
        <label for="my-user-id">Seu ID de Usuário:</label>
        <input type="number" id="my-user-id" readonly>
    </div>
    <button id="connect-btn" onclick="connect()" disabled>2. Conectar ao WebSocket</button>
    <button id="disconnect-btn" onclick="disconnect()" disabled>Desconectar</button>
    <p>Status: <span id="status" class="disconnected">Desconectado</span></p>
</div>

<div id="functionalities" style="display: none;">
    <div class="container">
        <h3>Etapa 3: Feed Público (Postagens)</h3>
        <div class="form-group">
            <label for="post-content">Nova Postagem:</label>
            <textarea id="post-content" placeholder="O que você está pensando?"></textarea>
        </div>
        <div class="form-group">
            <label for="post-files">Anexar Arquivos (Imagens, Vídeos, Áudios):</label>
            <input type="file" id="post-files" multiple>
        </div>
        <button onclick="createPost()">Enviar Postagem</button>
        <hr>
        <h4>Feed</h4>
        <div id="public-feed-window"></div>
    </div>

    <div class="container">
        <h3>Etapa 4: Chat Privado</h3>
        <div class="form-group">
            <label for="recipient-id">ID do Destinatário:</label>
            <input type="number" id="recipient-id" placeholder="Digite o ID e pressione Enter ou clique fora" onchange="fetchChatHistory()">
        </div>
        <div id="chat-window"></div>
        <div class="form-group" style="margin-top: 1rem;">
            <label for="message">Sua Mensagem:</label>
            <input type="text" id="message" placeholder="Digite sua mensagem...">
        </div>
        <button onclick="sendMessage()">Enviar Mensagem</button>
    </div>
</div>

<div id="editPostModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('editPostModal')">&times;</span>
        <h3>Editar Postagem</h3>
        <input type="hidden" id="edit-post-id">
        <div class="form-group">
            <label for="edit-post-content">Conteúdo:</label>
            <textarea id="edit-post-content"></textarea>
        </div>
        <div class="form-group">
            <label>Mídias Atuais (marque para remover):</label>
            <div id="edit-post-media-list"></div>
        </div>
        <div class="form-group">
            <label for="edit-post-files">Adicionar novos arquivos:</label>
            <input type="file" id="edit-post-files" multiple>
        </div>
        <button onclick="submitPostEdit()">Salvar Alterações</button>
    </div>
</div>

<div id="editMessageModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('editMessageModal')">&times;</span>
        <h3>Editar Mensagem</h3>
        <input type="hidden" id="edit-message-id">
        <div class="form-group">
            <label for="edit-message-content">Conteúdo:</label>
            <textarea id="edit-message-content"></textarea>
        </div>
        <button onclick="submitMessageEdit()">Salvar Alterações</button>
    </div>
</div>

<div id="editCommentModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('editCommentModal')">&times;</span>
        <h3>Editar Comentário</h3>
        <input type="hidden" id="edit-comment-id">
        <div class="form-group">
            <label for="edit-comment-content">Conteúdo:</label>
            <textarea id="edit-comment-content"></textarea>
        </div>
        <button onclick="submitCommentEdit()">Salvar Alterações</button>
    </div>
</div>

<script>
    let stompClient = null;
    let jwtToken = null;
    const activeSubscriptions = {};

    // --- FUNÇÕES DE AUTENTICAÇÃO E UTILITÁRIAS ---
    function getUserIdFromToken(token) {
        try {
            const payloadBase64 = token.split('.')[1];
            const decodedJson = atob(payloadBase64);
            const decodedPayload = JSON.parse(decodedJson);
            return decodedPayload.id;
        } catch (e) {
            console.error("Não foi possível decodificar o token.", e);
            return null;
        }
    }

    async function login() {
        const backendUrl = document.getElementById('backend-url').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            const response = await fetch(`${backendUrl}/autenticacao/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, senha: password })
            });
            if (!response.ok) throw new Error(`Falha no login: ${response.status}`);
            const data = await response.json();
            jwtToken = data.token;
            document.getElementById('jwt-token').value = jwtToken;
            document.getElementById('connect-btn').disabled = false;
            const userId = getUserIdFromToken(jwtToken);
            if (userId) document.getElementById('my-user-id').value = userId;
            alert("Login realizado com sucesso! Agora clique em 'Conectar'.");
        } catch (error) {
            console.error("Erro no login:", error);
            alert(error.message);
        }
    }

    // --- FUNÇÕES DE CONEXÃO E WEBSOCKET ---
    function connect() {
        if (!jwtToken) { alert("Faça o login primeiro."); return; }
        const backendUrl = document.getElementById('backend-url').value;
        const socket = new SockJS(`${backendUrl}/ws`);
        stompClient = Stomp.over(socket);
        stompClient.debug = null;
        const headers = { 'Authorization': 'Bearer ' + jwtToken };

        stompClient.connect(headers, function(frame) {
            console.log('CONECTADO COM SUCESSO');
            updateConnectionStatus(true);
            fetchPublicPosts();

            stompClient.subscribe(`/user/queue/usuario`, function(message) {
                const payload = JSON.parse(message.body);
                if (payload.tipo === 'remocao') {
                    document.getElementById(`message-${payload.id}`)?.remove();
                } else {
                    const myUserId = document.getElementById('my-user-id').value;
                    const currentRecipientId = document.getElementById('recipient-id').value;
                    if ((String(payload.remetenteId) === myUserId && String(payload.destinatarioId) === currentRecipientId) ||
                        (String(payload.remetenteId) === currentRecipientId && String(payload.destinatarioId) === myUserId)) {
                        showMessage(payload);
                    }
                }
            });

            stompClient.subscribe('/topic/publico', function(message) {
                const payload = JSON.parse(message.body);
                const postElement = document.getElementById(`post-${payload.postagemId || payload.id}`);
                
                if (payload.tipo === 'remocao') {
                    postElement?.remove();
                } else if (payload.tipo === 'edicao') {
                    fetchAndReplacePost(payload.postagem.id);
                } else { 
                    if(!postElement) showPublicPost(payload, true);
                }
            });
        }, function(error) {
            console.error('ERRO DE CONEXÃO:', error);
            updateConnectionStatus(false);
        });
    }

    function disconnect() {
        for (const topic in activeSubscriptions) {
            activeSubscriptions[topic].unsubscribe();
            delete activeSubscriptions[topic];
        }
        if (stompClient !== null) { stompClient.disconnect(); }
        updateConnectionStatus(false);
        console.log("Desconectado");
    }

    function updateConnectionStatus(isConnected) {
        const statusEl = document.getElementById('status');
        const functionalitiesEl = document.getElementById('functionalities');
        if (isConnected) {
            statusEl.textContent = 'Conectado';
            statusEl.className = 'connected';
            document.getElementById('disconnect-btn').disabled = false;
            document.getElementById('connect-btn').disabled = true;
            functionalitiesEl.style.display = 'block';
        } else {
            statusEl.textContent = 'Desconectado';
            statusEl.className = 'disconnected';
            document.getElementById('disconnect-btn').disabled = true;
            document.getElementById('connect-btn').disabled = (jwtToken === null);
            functionalitiesEl.style.display = 'none';
        }
    }

    // --- FUNÇÕES DE POSTAGEM ---
    async function fetchPublicPosts() {
        const feedWindow = document.getElementById('public-feed-window');
        feedWindow.innerHTML = '';
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/api/chat/publico`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro: ${response.status}`);
            const posts = await response.json();
            posts.forEach(post => showPublicPost(post, false));
        } catch (error) {
            alert(error.message);
        }
    }

    async function createPost() {
        const backendUrl = document.getElementById('backend-url').value;
        const content = document.getElementById('post-content').value;
        const files = document.getElementById('post-files').files;
        if (!content && files.length === 0) { alert("A postagem precisa de conteúdo ou arquivos."); return; }
        const formData = new FormData();
        formData.append('postagem', new Blob([JSON.stringify({ conteudo: content })], { type: 'application/json' }));
        for (let i = 0; i < files.length; i++) {
            formData.append('arquivos', files[i]);
        }
        try {
            const response = await fetch(`${backendUrl}/postagem/upload-mensagem`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + jwtToken },
                body: formData
            });
            if (!response.ok) throw new Error(`Erro ao criar postagem: ${await response.text()}`);
            document.getElementById('post-content').value = '';
            document.getElementById('post-files').value = null;
        } catch (error) {
            alert(error.message);
        }
    }
    
    // <<< NOVA FUNÇÃO PARA CURTIDAS >>>
    async function toggleLike(postagemId, comentarioId) {
        if (!jwtToken) {
            alert("Você precisa estar conectado para curtir.");
            return;
        }
        const backendUrl = document.getElementById('backend-url').value;
        const body = {};
        if (postagemId) body.postagemId = postagemId;
        if (comentarioId) body.comentarioId = comentarioId;

        try {
            const response = await fetch(`${backendUrl}/curtidas/toggle`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + jwtToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });
            if (!response.ok) {
                throw new Error(`Erro ao processar curtida: ${await response.text()}`);
            }
            // A UI será atualizada via WebSocket, então não precisamos fazer nada aqui.
        } catch (error) {
            console.error("Erro no toggleLike:", error);
            alert(error.message);
        }
    }

    // Função para criar elemento de postagem
    function createPostElement(post) {
        const postElement = document.createElement('div');
        postElement.className = 'post-container';
        postElement.id = `post-${post.id}`;
        postElement.dataset.authorId = post.autorId;

        let mediaHtml = '<div class="post-media">';
        const urls = post.urlsMidia || [];
        urls.forEach(url => {
            if (url.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { mediaHtml += `<img src="${url}">`; } 
            else if (url.match(/\.(mp4|webm|ogg)$/i)) { mediaHtml += `<video controls src="${url}"></video>`; } 
            else if (url.match(/\.(mp3|wav|m4a)$/i)) { mediaHtml += `<audio controls src="${url}"></audio>`; }
        });
        mediaHtml += '</div>';
        
        const dataFormatada = new Date(post.dataCriacao).toLocaleString('pt-BR');
        const myUserId = document.getElementById('my-user-id').value;
        let actionsHtml = (String(post.autorId) === myUserId) ? `
            <div class="post-actions">
                <button class="action-btn" onclick='openEditPostModal(${post.id}, ${JSON.stringify(urls)})'>Editar</button>
                <button class="action-btn danger" onclick="deletePost(${post.id})">Excluir</button>
            </div>` : '';
        
        // <<< NOVA BARRA DE AÇÕES PARA A POSTAGEM >>>
        const postActionsBar = `
            <div class="actions-bar">
                <button class="like-btn ${post.curtidoPeloUsuario ? 'liked' : ''}" onclick="toggleLike(${post.id}, null)">
                    ❤️ <span class="like-count">${post.totalCurtidas}</span>
                </button>
            </div>`;

        // Renderizar comentários com destaque e respostas
        let commentsHtml = `
            <div class="comments-section">
                <h4>Comentários</h4>
                <div class="comments-list" id="comentarios-${post.id}">`;
        
        if(post.comentarios && post.comentarios.length > 0) {
            const rootComments = post.comentarios.filter(c => !c.parentId);
            
            const sortedComments = rootComments.sort((a, b) => {
                if (a.destacado !== b.destacado) {
                    return b.destacado - a.destacado;
                }
                return new Date(a.dataCriacao) - new Date(b.dataCriacao);
            });

            sortedComments.forEach(comment => {
                commentsHtml += renderCommentWithReplies(comment, post.autorId, post.comentarios);
            });
        }
        
        commentsHtml += `</div>
            <div class="comment-form">
                <input type="text" id="comment-input-${post.id}" placeholder="Adicione um comentário...">
                <button onclick="sendComment(${post.id}, null)">Enviar</button>
            </div>
        </div>`;

        postElement.innerHTML = `
            ${actionsHtml}
            <div class="post-header"><strong>${post.nomeAutor}</strong> - ${dataFormatada}</div>
            <div class="post-content" id="post-content-${post.id}">${post.conteudo}</div>
            ${mediaHtml}
            ${postActionsBar}
            ${commentsHtml}
        `;
        
        subscribeToComments(post.id);
        return postElement;
    }

    function showPublicPost(post, prepend) {
        const feedWindow = document.getElementById('public-feed-window');
        const postElement = createPostElement(post);
        if (prepend) {
            feedWindow.prepend(postElement);
        } else {
            feedWindow.appendChild(postElement);
        }
    }

    async function fetchAndReplacePost(postId) {
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/postagem/${postId}`, {
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) return;
            const updatedPost = await response.json();
            
            const oldPostElement = document.getElementById(`post-${postId}`);
            if (oldPostElement) {
                const newPostElement = createPostElement(updatedPost);
                oldPostElement.replaceWith(newPostElement);
            }
        } catch (e) {
            console.error("Falha ao recarregar post:", e);
        }
    }

    async function deletePost(postId) {
        if (!confirm('Tem certeza que deseja excluir esta postagem?')) return;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/postagem/${postId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao excluir postagem: ${response.status}`);
        } catch (error) {
            alert(error.message);
        }
    }

    function openEditPostModal(postId, mediaUrls) {
        const postContent = document.getElementById(`post-content-${postId}`).innerText;
        document.getElementById('edit-post-id').value = postId;
        document.getElementById('edit-post-content').value = postContent;
        const mediaListDiv = document.getElementById('edit-post-media-list');
        mediaListDiv.innerHTML = '';
        if (mediaUrls && mediaUrls.length > 0) {
            mediaUrls.forEach(url => {
                const filename = url.substring(url.lastIndexOf('/') + 1);
                mediaListDiv.innerHTML += `
                    <div>
                        <input type="checkbox" id="remove-media-${filename}" name="urlsParaRemover" value="${url}">
                        <label for="remove-media-${filename}">${filename}</label>
                    </div>`;
            });
        } else {
            mediaListDiv.innerHTML = 'Nenhuma mídia anexada.';
        }
        openModal('editPostModal');
    }

    async function submitPostEdit() {
        const postId = document.getElementById('edit-post-id').value;
        const content = document.getElementById('edit-post-content').value;
        const newFiles = document.getElementById('edit-post-files').files;
        const urlsParaRemover = Array.from(document.querySelectorAll('#edit-post-media-list input:checked')).map(cb => cb.value);
        const formData = new FormData();
        formData.append('postagem', new Blob([JSON.stringify({ conteudo: content, urlsParaRemover })], { type: 'application/json' }));
        for (let i = 0; i < newFiles.length; i++) {
            formData.append('arquivos', newFiles[i]);
        }
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/postagem/${postId}`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + jwtToken },
                body: formData
            });
            if (!response.ok) throw new Error(`Erro ao editar postagem: ${await response.text()}`);
            closeModal('editPostModal');
            document.getElementById('edit-post-files').value = null;
        } catch(error) {
            alert(error.message);
        }
    }

    // --- FUNÇÕES DE COMENTÁRIOS ---
    function subscribeToComments(postId) {
        if (stompClient && stompClient.connected) {
            const topic = `/topic/postagem/${postId}/comentarios`;
            if (activeSubscriptions[topic]) return;
            const subscription = stompClient.subscribe(topic, function(message) {
                fetchAndReplacePost(postId);
            });
            activeSubscriptions[topic] = subscription;
        }
    }

    function renderCommentWithReplies(comment, postAuthorId, allComments) {
        let commentHtml = renderComment(comment, postAuthorId);
        
        const replies = allComments
            .filter(reply => reply.parentId === comment.id)
            .sort((a, b) => {
                if (a.destacado !== b.destacado) {
                    return b.destacado - a.destacado;
                }
                return new Date(a.dataCriacao) - new Date(b.dataCriacao);
            });

        if (replies.length > 0) {
            commentHtml += `<div class="comment-replies">`;
            replies.forEach(reply => {
                commentHtml += renderCommentWithReplies(reply, postAuthorId, allComments);
            });
            commentHtml += `</div>`;
        }
        return commentHtml;
    }
    
    function renderComment(comment, postAuthorId) {
        const myUserId = document.getElementById('my-user-id').value;
        const dataFormatada = new Date(comment.dataCriacao).toLocaleString('pt-BR');
        let actionsHtml = '';
        const isAuthor = String(comment.autorId) === myUserId;
        const isPostOwner = String(postAuthorId) === myUserId;

        if (isAuthor || isPostOwner) {
            actionsHtml = `<div class="comment-actions">`;
            if (isAuthor) {
                actionsHtml += `<button class="action-btn" onclick='openEditCommentModal(${comment.id}, \`${comment.conteudo.replace(/`/g, '\\`')}\`)'>E</button>`;
            }
            if (isAuthor || isPostOwner) {
                actionsHtml += `<button class="action-btn danger" onclick="deleteComment(${comment.id})">X</button>`;
            }
            if (isPostOwner) {
                 actionsHtml += `<button class="action-btn highlight" onclick="highlightComment(${comment.id})">★</button>`;
            }
            actionsHtml += `</div>`;
        }
        
        let replyInfoHtml = '';
        if (comment.replyingToName) {
            replyInfoHtml = `<div class="reply-info">Respondendo a <strong>${comment.replyingToName}</strong></div>`;
        }
        
        let highlightBadge = '';
        if(comment.destacado){
            highlightBadge = `<span class="highlight-badge">Destacado pelo criador</span>`;
        }
        
        // <<< NOVA BARRA DE AÇÕES PARA O COMENTÁRIO >>>
        const commentActionsFooter = `
            <div class="comment-actions-footer">
                <button class="like-btn ${comment.curtidoPeloUsuario ? 'liked' : ''}" onclick="toggleLike(null, ${comment.id})">
                    ❤️ <span class="like-count">${comment.totalCurtidas}</span>
                </button>
                <button class="action-btn" style="font-size:12px; padding: 4px 8px;" onclick="toggleReplyForm(${comment.id})">Responder</button>
            </div>`;

        return `
            <div class="comment-container ${comment.destacado ? 'destacado' : ''}" id="comment-${comment.id}">
                ${actionsHtml}
                <div class="comment-header"><strong>${comment.nomeAutor}</strong> ${highlightBadge} - ${dataFormatada}</div>
                ${replyInfoHtml}
                <p class="comment-content">${comment.conteudo}</p>
                ${commentActionsFooter}
                <div class="reply-form" id="reply-form-${comment.id}">
                    <input type="text" id="reply-input-${comment.id}" placeholder="Escreva sua resposta...">
                    <button onclick="sendComment(${comment.postagemId}, ${comment.id})">Enviar</button>
                </div>
            </div>`;
    }
    
    function sendComment(postId, parentId) {
        const inputId = parentId ? `reply-input-${parentId}` : `comment-input-${postId}`;
        const input = document.getElementById(inputId);
        const content = input.value.trim();
        if(stompClient && content) {
            stompClient.send(`/app/postagem/${postId}/comentar`, {}, JSON.stringify({ conteudo: content, parentId: parentId || null }));
            input.value = '';
            if(parentId) toggleReplyForm(parentId);
        }
    }
    
    function toggleReplyForm(commentId) {
        const form = document.getElementById(`reply-form-${commentId}`);
        form.style.display = form.style.display === 'none' ? 'flex' : 'none';
    }
    
    async function highlightComment(commentId) {
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/comentarios/${commentId}/destacar`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao destacar comentário: ${await response.text()}`);
        } catch (error) {
            alert(error.message);
        }
    }

    function openEditCommentModal(commentId, currentContent) {
        document.getElementById('edit-comment-id').value = commentId;
        document.getElementById('edit-comment-content').value = currentContent;
        openModal('editCommentModal');
    }

    async function submitCommentEdit() {
        const commentId = document.getElementById('edit-comment-id').value;
        const content = document.getElementById('edit-comment-content').value;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/comentarios/${commentId}`, {
                method: 'PUT',
                headers: { 'Authorization': 'Bearer ' + jwtToken, 'Content-Type': 'application/json' },
                body: JSON.stringify(content)
            });
            if (!response.ok) throw new Error(`Erro ao editar comentário: ${await response.text()}`);
            closeModal('editCommentModal');
        } catch (error) {
            alert(error.message);
        }
    }

    async function deleteComment(commentId) {
        if (!confirm('Tem certeza?')) return;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/comentarios/${commentId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao excluir comentário: ${response.status}`);
        } catch (error) {
            alert(error.message);
        }
    }

    // --- FUNÇÕES DO CHAT PRIVADO ---
    async function fetchChatHistory() {
        const myUserId = document.getElementById('my-user-id').value;
        const recipientId = document.getElementById('recipient-id').value;
        const chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML = '';
        if (!myUserId || !recipientId) { return; }
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/api/chat/privado/${myUserId}/${recipientId}`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if (!response.ok) throw new Error(`Erro ao buscar histórico: ${response.status}`);
            const history = await response.json();
            history.forEach(message => showMessage(message));
        } catch (error) {
            alert(error.message);
        }
    }

    function sendMessage() {
        const recipientId = document.getElementById('recipient-id').value;
        const messageContent = document.getElementById('message').value;
        if (stompClient && messageContent && recipientId) {
            const chatMessage = {
                conteudo: messageContent,
                destinatarioId: parseInt(recipientId)
            };
            stompClient.send(`/app/privado/${recipientId}`, {}, JSON.stringify(chatMessage));
            document.getElementById('message').value = '';
        } else {
            alert("Verifique a conexão e preencha o ID do destinatário e a mensagem.");
        }
    }

    function showMessage(message) {
        const chatWindow = document.getElementById('chat-window');
        const existingElement = document.getElementById(`message-${message.id}`);
        if(existingElement) { 
             existingElement.querySelector('p').innerText = message.conteudo;
             return;
        }
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.id = `message-${message.id}`;
        
        const myUserId = document.getElementById('my-user-id').value;
        const senderId = message.remetenteId || (message.remetente ? message.remetente.id : null);
        const senderName = message.nomeRemetente || (message.remetente ? message.remetente.nome : 'Desconhecido');
        
        let actionsHtml = '';
        if (String(senderId) === myUserId) {
            messageElement.classList.add('sent');
            actionsHtml = `
                <div class="message-actions">
                    <button class="action-btn" onclick='openEditMessageModal(${message.id}, \`${message.conteudo.replace(/`/g, '\\`')}\`)'>E</button>
                    <button class="action-btn danger" onclick="deletePrivateMessage(${message.id})">X</button>
                </div>`;
        } else {
            messageElement.classList.add('received');
        }
        messageElement.innerHTML = `
            ${actionsHtml}
            <strong>${senderName}:</strong>
            <p>${message.conteudo}</p>
        `;
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    async function deletePrivateMessage(messageId) {
        if(!confirm('Tem certeza?')) return;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/api/chat/privado/${messageId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + jwtToken }
            });
            if(!response.ok) throw new Error(`Erro ao excluir: ${response.status}`);
        } catch(error) {
            alert(error.message);
        }
    }
    
    function openEditMessageModal(messageId, currentContent) {
        document.getElementById('edit-message-id').value = messageId;
        document.getElementById('edit-message-content').value = currentContent;
        openModal('editMessageModal');
    }

    async function submitMessageEdit() {
        const messageId = document.getElementById('edit-message-id').value;
        const content = document.getElementById('edit-message-content').value;
        try {
            const response = await fetch(`${document.getElementById('backend-url').value}/api/chat/privado/${messageId}`, {
                method: 'PUT',
                headers: { 
                    'Authorization': 'Bearer ' + jwtToken,
                    'Content-Type': 'application/json'
                 },
                body: JSON.stringify(content)
            });
            if(!response.ok) throw new Error(`Erro ao editar: ${await response.text()}`);
            closeModal('editMessageModal');
        } catch(error) {
            alert(error.message);
        }
    }

    // --- FUNÇÕES DO MODAL ---
    function openModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }
</script>
</body>
</html>